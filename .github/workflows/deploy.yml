name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.1.0'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev

      - name: Install R dependencies
        run: |
          R -e "install.packages(c('shiny', 'renv'), repos='https://cloud.r-project.org')"

      - name: Test Shiny application
        run: |
          R -e 'shiny::runApp(launch.browser = FALSE, port = 8080, host = "0.0.0.0")' &
          sleep 15
          curl -f http://localhost:8080 || exit 1
          pkill -f "R.*shiny"

      - name: Deploy to GitHub Pages
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Set up Git configuration for GitHub Actions
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # Create and switch to gh-pages branch
          git checkout --orphan gh-pages
          
          # Remove all existing files
          git rm -rf .
          
          # Create minimal GitHub Pages content
          echo '# plant_breeding_analysis_app' > index.md
          echo '' >> index.md
          echo 'A comprehensive R/Shiny application for plant breeding data analysis' >> index.md
          echo '' >> index.md
          echo 'This Shiny application is deployed using GitHub Actions.' >> index.md
          echo '' >> index.md
          echo '## Repository' >> index.md
          echo '- [View Source Code](https://github.com/Kiplagatnoel/plant_breeding_analysis_app)' >> index.md
          
          # Disable Jekyll
          touch .nojekyll
          
          # Stage all files
          git add -A
          
          # Commit changes
          git commit -m 'Deploy to GitHub Pages: $(date +"%Y-%m-%d %H:%M:%S")'
          
          # Push to GitHub Pages branch
          git push origin gh-pages --force

